# ğŸ” Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± - Analysis Pack v2.1

> **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.1.0  
> **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** ÙŠÙ†Ø§ÙŠØ± 2026  
> **Ø§Ù„ØºØ±Ø¶:** ØªØ¹Ø±ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… RBAC Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

---

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙŠÙØ¹Ø±Ù‘Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (RBAC) Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ù„ÙŠØ¯Ø²Ø²Ø² SaaS Multi-tenant.

---

## ğŸ‘¥ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ROLE HIERARCHY                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                          â”‚  OWNER  â”‚                                    â”‚
â”‚                          â”‚ (ÙˆØ§Ø­Ø¯)  â”‚                                    â”‚
â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â”‚
â”‚                               â”‚                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                                    â”‚
â”‚                          â”‚  ADMIN  â”‚                                    â”‚
â”‚                          â”‚ (Ù…ØªØ¹Ø¯Ø¯) â”‚                                    â”‚
â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â”‚
â”‚                               â”‚                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                                    â”‚
â”‚                          â”‚ MANAGER â”‚                                    â”‚
â”‚                          â”‚ (Ù…ØªØ¹Ø¯Ø¯) â”‚                                    â”‚
â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â”‚
â”‚                               â”‚                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                                    â”‚
â”‚                          â”‚  SALES  â”‚                                    â”‚
â”‚                          â”‚ (Ù…ØªØ¹Ø¯Ø¯) â”‚                                    â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±

| Ø§Ù„Ø¯ÙˆØ± | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù‚ÙŠÙˆØ¯ | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ |
|-------|-------|--------|-------------|
| **OWNER** | Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©ØŒ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© | ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„ÙƒÙ„ TenantØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ | 1 |
| **ADMIN** | Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª | ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Billing | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **MANAGER** | Ù…Ø¯ÙŠØ± ÙØ±ÙŠÙ‚ | ÙŠØ±Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±ÙŠÙ‚Ù‡ ÙÙ‚Ø· | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **SALES** | Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¨ÙŠØ¹Ø§Øª | ÙŠØ±Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙ‚Ø· | Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø© |

---

## ğŸ”‘ Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Scopes)

```typescript
type DataScope = 'all' | 'team' | 'own' | 'none';

// all  = Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Tenant
// team = Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØ­Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ Manager)
// own  = Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
// none = Ù„Ø§ ÙˆØµÙˆÙ„
```

### ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª

```sql
-- Example: leads query with scope
SELECT * FROM leads 
WHERE tenant_id = :tenantId
  AND (
    -- OWNER/ADMIN: all
    :userRole IN ('OWNER', 'ADMIN')
    OR
    -- MANAGER: team (leads created by team members)
    (:userRole = 'MANAGER' AND created_by IN (
      SELECT user_id FROM memberships 
      WHERE tenant_id = :tenantId 
        AND manager_id = :userId
    ))
    OR
    -- SALES: own
    (:userRole = 'SALES' AND created_by = :userId)
  );
```

---

## ğŸ“Š Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©

### Leads (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `leads:read` | all | all | team | own | Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ |
| `leads:create` | âœ“ | âœ“ | âœ“ | âœ“ | Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ |
| `leads:update` | all | all | team | own | ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ |
| `leads:delete` | âœ“ | âœ“ | âœ— | âœ— | Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ |
| `leads:export` | âœ“ | âœ“ | âœ“ | âœ— | ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ |
| `leads:import` | âœ“ | âœ“ | âœ“ | âœ— | Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù…Ù„Ø§Ø¡ |
| `leads:bulk_actions` | âœ“ | âœ“ | âœ“ | âœ— | Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© |
| `leads:assign` | âœ“ | âœ“ | team | âœ— | ØªØ¹ÙŠÙŠÙ† Ø¹Ù…ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… |
| `leads:transfer` | âœ“ | âœ“ | âœ— | âœ— | Ù†Ù‚Ù„ Ø¹Ù…ÙŠÙ„ Ø¨ÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† |

---

### Lists (Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `lists:read` | all | all | team | own | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… |
| `lists:create` | âœ“ | âœ“ | âœ“ | âœ“ | Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© |
| `lists:update` | all | all | own | own | ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© |
| `lists:delete` | all | all | own | own | Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© |
| `lists:share` | âœ“ | âœ“ | âœ“ | âœ— | Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© |

---

### Evidence (Ø§Ù„Ø£Ø¯Ù„Ø©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `evidence:read` | all | all | team | own | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø¯Ù„Ø© |
| `evidence:create` | âœ“ | âœ“ | âœ“ | âœ“ | Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ù„ÙŠÙ„ (Ø¹Ø¨Ø± Survey) |
| `evidence:delete` | âœ“ | âœ“ | âœ— | âœ— | Ø­Ø°Ù Ø¯Ù„ÙŠÙ„ |
| `evidence:refresh` | âœ“ | âœ“ | âœ“ | âœ“ | ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯Ù„Ø© |

---

### Reports (Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `reports:read` | all | all | team | own | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± |
| `reports:generate` | âœ“ | âœ“ | âœ“ | âœ“ | ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯ |
| `reports:export` | âœ“ | âœ“ | âœ“ | âœ— | ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± |

---

### Jobs (Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `jobs:read` | all | all | team | own | Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… |
| `jobs:create` | âœ“ | âœ“ | âœ“ | âœ“ | Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© |
| `jobs:cancel` | all | all | own | own | Ø¥Ù„ØºØ§Ø¡ Ù…Ù‡Ù…Ø© |
| `jobs:retry` | âœ“ | âœ“ | own | own | Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© |

---

### WhatsApp (Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `whatsapp:send` | âœ“ | âœ“ | âœ“ | âœ“ | Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙØ±Ø¯ÙŠØ© |
| `whatsapp:bulk_send` | âœ“ | âœ“ | âœ“ | âœ— | Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ |
| `whatsapp:templates:read` | âœ“ | âœ“ | âœ“ | âœ“ | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ |
| `whatsapp:templates:manage` | âœ“ | âœ“ | âœ— | âœ— | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ |
| `whatsapp:logs:read` | all | all | team | own | Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ |

---

### Search (Ø§Ù„Ø¨Ø­Ø«)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `search:execute` | âœ“ | âœ“ | âœ“ | âœ“ | ØªÙ†ÙÙŠØ° Ø¨Ø­Ø« |
| `search:history` | all | all | own | own | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø­Ø« |
| `search:save` | âœ“ | âœ“ | âœ“ | âœ“ | Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« |

---

### Team (Ø§Ù„ÙØ±ÙŠÙ‚)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `team:read` | âœ“ | âœ“ | team | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ |
| `team:invite` | âœ“ | âœ“ | âœ— | âœ— | Ø¯Ø¹ÙˆØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ |
| `team:remove` | âœ“ | âœ“ | âœ— | âœ— | Ø¥Ø²Ø§Ù„Ø© Ø¹Ø¶Ùˆ |
| `team:change_role` | âœ“ | âœ“* | âœ— | âœ— | ØªØºÙŠÙŠØ± Ø¯ÙˆØ± |
| `team:deactivate` | âœ“ | âœ“ | âœ— | âœ— | ØªØ¹Ø·ÙŠÙ„ Ø¹Ø¶Ùˆ |

*ADMIN Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± Ø¯ÙˆØ± OWNER Ø£Ùˆ ØªØ±Ù‚ÙŠØ© Ø£Ø­Ø¯ Ù„Ù€ OWNER

---

### Integrations (Ø§Ù„ØªÙƒØ§Ù…Ù„Ø§Øª)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `integrations:read` | âœ“ | âœ“ | âœ— | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„Ø§Øª |
| `integrations:manage` | âœ“ | âœ“ | âœ— | âœ— | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„Ø§Øª |
| `api_keys:read` | âœ“ | âœ“ | âœ— | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ù…ÙØ§ØªÙŠØ­ API |
| `api_keys:manage` | âœ“ | âœ“ | âœ— | âœ— | Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ API |

---

### Audit (Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `audit:read` | âœ“ | âœ“ | âœ— | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© |
| `audit:export` | âœ“ | âœ“ | âœ— | âœ— | ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ |

---

### Organization Settings (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `org:settings:read` | âœ“ | âœ“ | âœ— | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª |
| `org:settings:update` | âœ“ | âœ“ | âœ— | âœ— | ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª |
| `org:delete` | âœ“ | âœ— | âœ— | âœ— | Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¸Ù…Ø© |
| `org:transfer` | âœ“ | âœ— | âœ— | âœ— | Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© |

---

### Billing (Ø§Ù„ÙÙˆØªØ±Ø©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `billing:read` | âœ“ | read* | âœ— | âœ— | Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙˆØªØ±Ø© |
| `billing:manage` | âœ“ | âœ— | âœ— | âœ— | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ |
| `billing:invoices` | âœ“ | âœ“ | âœ— | âœ— | Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ± |

*ADMIN ÙŠØ±Ù‰ Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ‚Ø·ØŒ Ù„Ø§ ÙŠØ±Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹

---

### Extension (Ø§Ù„Ø¥Ø¶Ø§ÙØ©)

| Permission | OWNER | ADMIN | MANAGER | SALES | Notes |
|------------|:-----:|:-----:|:-------:|:-----:|-------|
| `extension:use` | âœ“ | âœ“ | âœ“ | âœ“ | Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© |
| `extension:resolve` | âœ“ | âœ“ | âœ“ | âœ“ | ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª |
| `extension:reveal` | âœ“* | âœ“* | âœ“* | âœ“* | ÙƒØ´Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª |
| `extension:survey` | âœ“ | âœ“ | âœ“ | âœ“ | ÙØ­Øµ Ø¹Ù…ÙŠÙ‚ |

*ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Feature Flag `feature_reveal`

---

## ğŸ”’ Ù‚ÙˆØ§Ø¹Ø¯ Ø®Ø§ØµØ©

### 1. Ø­Ù…Ø§ÙŠØ© OWNER

```typescript
// OWNER Ù„Ø§ ÙŠÙ…ÙƒÙ†:
// - Ø­Ø°ÙÙ‡
// - ØªØºÙŠÙŠØ± Ø¯ÙˆØ±Ù‡
// - ØªØ¹Ø·ÙŠÙ„Ù‡

function canModifyMember(actor: User, target: Membership): boolean {
  if (target.role === 'OWNER') {
    return false; // Ù„Ø§ Ø£Ø­Ø¯ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ OWNER
  }
  
  if (actor.role === 'ADMIN' && target.role === 'ADMIN') {
    return false; // ADMIN Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ ADMIN Ø¢Ø®Ø±
  }
  
  return hasPermission(actor, 'team:change_role');
}
```

### 2. Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©

```typescript
// ÙÙ‚Ø· OWNER ÙŠÙ…ÙƒÙ†Ù‡ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©
async function transferOwnership(
  currentOwner: User,
  newOwnerId: string
): Promise<void> {
  if (currentOwner.role !== 'OWNER') {
    throw new ForbiddenError('Only OWNER can transfer ownership');
  }
  
  // Transaction:
  // 1. Set new owner role to OWNER
  // 2. Set current owner role to ADMIN
  // 3. Log audit event
}
```

### 3. Self-demotion Prevention

```typescript
// Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ®ÙÙŠØ¶ Ø¯ÙˆØ±Ù‡ Ø¨Ù†ÙØ³Ù‡
function canChangeOwnRole(user: User, newRole: Role): boolean {
  const roleHierarchy = { OWNER: 4, ADMIN: 3, MANAGER: 2, SALES: 1 };
  
  if (roleHierarchy[newRole] < roleHierarchy[user.role]) {
    return false; // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ®ÙÙŠØ¶ Ø§Ù„Ø¯ÙˆØ±
  }
  
  return true;
}
```

### 4. Last Admin Protection

```typescript
// Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ø¢Ø®Ø± ADMIN
async function canRemoveAdmin(tenantId: string): Promise<boolean> {
  const adminCount = await countAdmins(tenantId);
  return adminCount > 1; // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ admin ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
}
```

---

## ğŸ—„ï¸ Database Schema

### Roles Table

```sql
CREATE TABLE roles (
  id VARCHAR(20) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  description TEXT,
  is_system BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO roles (id, name, description) VALUES
  ('OWNER', 'Ù…Ø§Ù„Ùƒ', 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù†Ø¸Ù…Ø© - ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©'),
  ('ADMIN', 'Ù…Ø¯ÙŠØ±', 'Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª'),
  ('MANAGER', 'Ù…Ø¯ÙŠØ± ÙØ±ÙŠÙ‚', 'Ù…Ø¯ÙŠØ± ÙØ±ÙŠÙ‚ - ÙŠØ±Ù‰ ÙØ±ÙŠÙ‚Ù‡ ÙÙ‚Ø·'),
  ('SALES', 'Ù…Ù†Ø¯ÙˆØ¨', 'Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¨ÙŠØ¹Ø§Øª - ÙŠØ±Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙ‚Ø·');
```

### Permissions Table

```sql
CREATE TABLE permissions (
  id VARCHAR(50) PRIMARY KEY,
  resource VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Example permissions
INSERT INTO permissions (id, resource, action) VALUES
  ('leads:read', 'leads', 'read'),
  ('leads:create', 'leads', 'create'),
  ('leads:update', 'leads', 'update'),
  ('leads:delete', 'leads', 'delete'),
  -- ... etc
```

### Role Permissions Table

```sql
CREATE TABLE role_permissions (
  role_id VARCHAR(20) REFERENCES roles(id),
  permission_id VARCHAR(50) REFERENCES permissions(id),
  scope VARCHAR(20) DEFAULT 'all',  -- all, team, own, none
  PRIMARY KEY (role_id, permission_id)
);

-- Example mappings
INSERT INTO role_permissions (role_id, permission_id, scope) VALUES
  ('OWNER', 'leads:read', 'all'),
  ('ADMIN', 'leads:read', 'all'),
  ('MANAGER', 'leads:read', 'team'),
  ('SALES', 'leads:read', 'own'),
  -- ... etc
```

---

## ğŸ” Permission Check Implementation

```typescript
interface PermissionCheck {
  userId: string;
  tenantId: string;
  permission: string;
  resourceId?: string;  // For resource-level checks
}

async function hasPermission(check: PermissionCheck): Promise<boolean> {
  const membership = await getMembership(check.userId, check.tenantId);
  if (!membership || membership.status !== 'ACTIVE') {
    return false;
  }
  
  const rolePermission = await getRolePermission(
    membership.role,
    check.permission
  );
  
  if (!rolePermission) {
    return false;
  }
  
  // If no resource specified, just check permission exists
  if (!check.resourceId) {
    return true;
  }
  
  // Check scope
  switch (rolePermission.scope) {
    case 'all':
      return true;
      
    case 'team':
      return await isInTeam(check.userId, check.resourceId);
      
    case 'own':
      return await isOwner(check.userId, check.resourceId);
      
    case 'none':
      return false;
      
    default:
      return false;
  }
}
```

---

## ğŸ¯ API Authorization Middleware

```typescript
// NestJS Guard Example
@Injectable()
export class PermissionGuard implements CanActivate {
  constructor(private reflector: Reflector) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requiredPermission = this.reflector.get<string>(
      'permission',
      context.getHandler()
    );
    
    if (!requiredPermission) {
      return true; // No permission required
    }
    
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    const tenantId = request.headers['x-tenant-id'] || user.currentTenantId;
    
    return hasPermission({
      userId: user.id,
      tenantId,
      permission: requiredPermission,
      resourceId: request.params.id
    });
  }
}

// Usage
@Controller('leads')
export class LeadsController {
  @Get()
  @Permission('leads:read')
  async findAll() { ... }
  
  @Post()
  @Permission('leads:create')
  async create() { ... }
  
  @Delete(':id')
  @Permission('leads:delete')
  async delete() { ... }
}
```

---

## ğŸ“Š Permission Matrix Summary (Quick Reference)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERMISSION MATRIX SUMMARY                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Resource      â”‚ OWNER â”‚ ADMIN â”‚ MANAGER â”‚ SALES â”‚                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚  Leads         â”‚ CRUD  â”‚ CRUD  â”‚ CRU(t)  â”‚ CRU(o)â”‚                      â”‚
â”‚  Lists         â”‚ CRUD  â”‚ CRUD  â”‚ CRUD(o) â”‚ CRUD(o)                      â”‚
â”‚  Evidence      â”‚ CRD   â”‚ CRD   â”‚ CR(t)   â”‚ CR(o) â”‚                      â”‚
â”‚  Reports       â”‚ CRE   â”‚ CRE   â”‚ CR(t)   â”‚ CR(o) â”‚                      â”‚
â”‚  Jobs          â”‚ CRUD  â”‚ CRUD  â”‚ CRU(o)  â”‚ CRU(o)â”‚                      â”‚
â”‚  WhatsApp      â”‚ Full  â”‚ Full  â”‚ Send    â”‚ Send  â”‚                      â”‚
â”‚  Team          â”‚ Full  â”‚ Full* â”‚ Read(t) â”‚ âœ—     â”‚                      â”‚
â”‚  Integrations  â”‚ Full  â”‚ Full  â”‚ âœ—       â”‚ âœ—     â”‚                      â”‚
â”‚  Audit         â”‚ Read  â”‚ Read  â”‚ âœ—       â”‚ âœ—     â”‚                      â”‚
â”‚  Org Settings  â”‚ Full  â”‚ RU    â”‚ âœ—       â”‚ âœ—     â”‚                      â”‚
â”‚  Billing       â”‚ Full  â”‚ Read  â”‚ âœ—       â”‚ âœ—     â”‚                      â”‚
â”‚                                                                          â”‚
â”‚  Legend:                                                                 â”‚
â”‚  C=Create, R=Read, U=Update, D=Delete, E=Export                         â”‚
â”‚  (t)=team scope, (o)=own scope                                          â”‚
â”‚  *ADMIN cannot modify OWNER                                              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â“ Open Questions

| # | Ø§Ù„Ø³Ø¤Ø§Ù„ | Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù‚Ù‚ |
|---|--------|--------------|
| 1 | Ù‡Ù„ Ù†Ø­ØªØ§Ø¬ Ø£Ø¯ÙˆØ§Ø± Ù…Ø®ØµØµØ© (Custom Roles)ØŸ | Product decision |
| 2 | Ù‡Ù„ MANAGER ÙŠÙ…ÙƒÙ†Ù‡ Ø¯Ø¹ÙˆØ© SALESØŸ | Product decision |
| 3 | Ù‡Ù„ Ù†Ø­ØªØ§Ø¬ Permission GroupsØŸ | Technical review |

---

> **Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:** [14-CONFLICTS_AND_FIXES.md](./14-CONFLICTS_AND_FIXES.md)  
> **Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:** [16-SUBSCRIPTION_QUOTAS_FLAGS.md](./16-SUBSCRIPTION_QUOTAS_FLAGS.md)
