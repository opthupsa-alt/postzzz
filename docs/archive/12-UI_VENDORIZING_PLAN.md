# ğŸ“¦ Ø®Ø·Ø© Ù†Ù‚Ù„ UI Ù„Ù„Ù€ Extension - Analysis Pack v2

> **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.0.0  
> **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** ÙŠÙ†Ø§ÙŠØ± 2026  
> **Ø§Ù„Ø­Ø§Ù„Ø©:** ØªØµÙ…ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠ - Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°

---

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙŠÙØ¹Ø±Ù‘Ù Ø®Ø·Ø© Ù†Ù‚Ù„/Ø³Ø­Ø¨ UI Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù€ Extension Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ‚Ù„Ø§Ù„ÙŠØ© Ø§Ù„Ù€ Extension Ø§Ù„ÙƒØ§Ù…Ù„Ø©.

### Ø§Ù„Ù‡Ø¯Ù

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              GOAL                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„/Ø§Ù„Ù…Ø¸Ù‡Ø±/Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨ØµØ±ÙŠ                                        â”‚
â”‚  Same Look & Feel                                                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚                     â”‚         â”‚                     â”‚               â”‚
â”‚  â”‚    Web App UI       â”‚   â•â•â•   â”‚   Extension UI      â”‚               â”‚
â”‚  â”‚                     â”‚         â”‚                     â”‚               â”‚
â”‚  â”‚  - Same colors      â”‚         â”‚  - Same colors      â”‚               â”‚
â”‚  â”‚  - Same fonts       â”‚         â”‚  - Same fonts       â”‚               â”‚
â”‚  â”‚  - Same components  â”‚         â”‚  - Same components  â”‚               â”‚
â”‚  â”‚  - Same RTL         â”‚         â”‚  - Same RTL         â”‚               â”‚
â”‚  â”‚                     â”‚         â”‚                     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                          â”‚
â”‚  BUT: Extension is 100% independent at runtime                          â”‚
â”‚       No imports from webapp, no shared runtime                         â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Approach A: Vendoring at Build-time (Preferred)

### Ø§Ù„Ù…ÙÙ‡ÙˆÙ…

```
Build-time Copy:
webapp/src/components/* â”€â”€â–º extension/src/ui/components/*
webapp/src/styles/*     â”€â”€â–º extension/src/ui/styles/*
webapp/src/assets/*     â”€â”€â–º extension/src/ui/assets/*

Result: Extension has its own copy, no runtime dependency
```

### Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù†Ø³Ø®Ù‡Ø§

#### 1. Components (Ù…Ù† `web/components/`)

| Component | File | Priority | Notes |
|-----------|------|----------|-------|
| PageHeader | `PageHeader.tsx` | HIGH | Used in all views |
| DataTable | `DataTable.tsx` | HIGH | For lists display |
| StatCard | `StatCard.tsx` | MEDIUM | For stats |
| WhatsAppModal | `WhatsAppModal.tsx` | HIGH | WhatsApp send |
| JobProgressWidget | `JobProgressWidget.tsx` | HIGH | Job status |
| NotificationToast | `NotificationToast.tsx` | HIGH | Toasts |
| Guard | `Guard.tsx` | HIGH | Permission checks |
| SmartFilters | `SmartFilters.tsx` | MEDIUM | Filtering |
| BulkActionsBar | `BulkActionsBar.tsx` | LOW | Bulk actions |

#### 2. Pages (Ù…Ù† `web/pages/`)

| Page | File | Priority | Adaptation Needed |
|------|------|----------|-------------------|
| ExtensionSidePanel | `ExtensionSidePanel.tsx` | CRITICAL | Base for Side Panel |
| LeadDetailPage | `LeadDetailPage.tsx` | HIGH | Lead view (simplified) |
| - | - | - | Other pages NOT needed |

#### 3. Styles

| Item | Source | Notes |
|------|--------|-------|
| Design Tokens | Inline TailwindCSS | Extract to CSS variables |
| RTL Support | Inline styles | Keep as-is |
| Colors | Inline | Extract to theme file |
| Fonts | System fonts | No change needed |

#### 4. Assets

| Asset | Source | Notes |
|-------|--------|-------|
| Logo | `assets/logo.svg` | Copy |
| Icons | Lucide React | Keep dependency |
| i18n | `locales/*.json` | Copy if exists |

### Vendoring Script

```javascript
// scripts/vendor-ui.js
const fs = require('fs-extra');
const path = require('path');

const WEBAPP_SRC = path.resolve(__dirname, '../web');
const EXTENSION_UI = path.resolve(__dirname, '../extension/src/ui');

const ALLOWLIST = {
  components: [
    'PageHeader.tsx',
    'DataTable.tsx',
    'StatCard.tsx',
    'WhatsAppModal.tsx',
    'JobProgressWidget.tsx',
    'NotificationToast.tsx',
    'Guard.tsx',
    'SmartFilters.tsx'
  ],
  pages: [
    'ExtensionSidePanel.tsx'
  ],
  assets: [
    'logo.svg'
  ]
};

async function vendorUI() {
  console.log('ğŸ”„ Vendoring UI from webapp to extension...');
  
  // Clean destination
  await fs.emptyDir(EXTENSION_UI);
  
  // Copy components
  for (const file of ALLOWLIST.components) {
    const src = path.join(WEBAPP_SRC, 'components', file);
    const dest = path.join(EXTENSION_UI, 'components', file);
    
    if (await fs.pathExists(src)) {
      await fs.copy(src, dest);
      console.log(`  âœ… ${file}`);
    } else {
      console.log(`  âš ï¸ ${file} not found`);
    }
  }
  
  // Copy pages
  for (const file of ALLOWLIST.pages) {
    const src = path.join(WEBAPP_SRC, 'pages', file);
    const dest = path.join(EXTENSION_UI, 'pages', file);
    
    if (await fs.pathExists(src)) {
      await fs.copy(src, dest);
      console.log(`  âœ… ${file}`);
    }
  }
  
  // Copy assets
  for (const file of ALLOWLIST.assets) {
    const src = path.join(WEBAPP_SRC, 'assets', file);
    const dest = path.join(EXTENSION_UI, 'assets', file);
    
    if (await fs.pathExists(src)) {
      await fs.copy(src, dest);
      console.log(`  âœ… ${file}`);
    }
  }
  
  console.log('âœ… Vendoring complete!');
}

vendorUI().catch(console.error);
```

### Import Transformation

Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø®ØŒ ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ imports:

```typescript
// BEFORE (in webapp)
import { useStore } from '../store/useStore';
import { showToast } from '../utils/toast';

// AFTER (in extension)
import { useExtensionStore } from '../store/useExtensionStore';
import { showToast } from '../utils/toast';
```

**Transformation Script:**

```javascript
// scripts/transform-imports.js
const replace = require('replace-in-file');

const TRANSFORMS = [
  {
    from: /from ['"]\.\.\/store\/useStore['"]/g,
    to: "from '../store/useExtensionStore'"
  },
  {
    from: /from ['"]\.\.\/\.\.\/store\/useStore['"]/g,
    to: "from '../../store/useExtensionStore'"
  },
  {
    from: /useNavigate\(\)/g,
    to: 'useExtensionNavigate()'
  },
  {
    from: /import \{ useNavigate \} from ['"]react-router-dom['"]/g,
    to: "import { useExtensionNavigate } from '../hooks/useExtensionNavigate'"
  }
];

async function transformImports() {
  for (const transform of TRANSFORMS) {
    await replace({
      files: 'extension/src/ui/**/*.tsx',
      from: transform.from,
      to: transform.to
    });
  }
}
```

### Extension Store (Replacement for Zustand)

```typescript
// extension/src/store/useExtensionStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

interface ExtensionState {
  // Auth
  auth: {
    token: string | null;
    user: User | null;
    tenant: Tenant | null;
  };
  
  // Current context
  currentLead: Lead | null;
  currentEvidence: Evidence[];
  currentReport: Report | null;
  
  // Jobs
  activeJobs: Job[];
  
  // UI
  sidePanel: {
    activeTab: 'overview' | 'contacts' | 'evidence' | 'activity';
    isRevealing: boolean;
    isSurveying: boolean;
  };
  
  // Actions
  setAuth: (auth: AuthState) => void;
  setCurrentLead: (lead: Lead | null) => void;
  addEvidence: (evidence: Evidence) => void;
  updateJob: (jobId: string, updates: Partial<Job>) => void;
  // ... more actions
}

export const useExtensionStore = create<ExtensionState>()(
  persist(
    (set, get) => ({
      // Initial state
      auth: { token: null, user: null, tenant: null },
      currentLead: null,
      currentEvidence: [],
      currentReport: null,
      activeJobs: [],
      sidePanel: {
        activeTab: 'overview',
        isRevealing: false,
        isSurveying: false
      },
      
      // Actions
      setAuth: (auth) => set({ auth }),
      setCurrentLead: (lead) => set({ currentLead: lead }),
      addEvidence: (evidence) => set((state) => ({
        currentEvidence: [...state.currentEvidence, evidence]
      })),
      updateJob: (jobId, updates) => set((state) => ({
        activeJobs: state.activeJobs.map(j => 
          j.id === jobId ? { ...j, ...updates } : j
        )
      }))
    }),
    {
      name: 'leedz-extension-storage',
      storage: createJSONStorage(() => ({
        getItem: async (name) => {
          const result = await chrome.storage.local.get(name);
          return result[name] || null;
        },
        setItem: async (name, value) => {
          await chrome.storage.local.set({ [name]: value });
        },
        removeItem: async (name) => {
          await chrome.storage.local.remove(name);
        }
      }))
    }
  )
);
```

### Build Configuration

```javascript
// extension/vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react()],
  
  build: {
    outDir: 'dist',
    rollupOptions: {
      input: {
        sidepanel: resolve(__dirname, 'sidepanel.html'),
        background: resolve(__dirname, 'src/background.ts'),
        content: resolve(__dirname, 'src/content.ts')
      },
      output: {
        entryFileNames: '[name].js',
        chunkFileNames: 'chunks/[name].[hash].js',
        assetFileNames: 'assets/[name].[ext]'
      }
    },
    
    // MV3 CSP compliance
    target: 'esnext',
    minify: 'terser',
    terserOptions: {
      format: {
        comments: false
      }
    }
  },
  
  // No eval() for CSP
  esbuild: {
    drop: ['console', 'debugger']
  }
});
```

---

## ğŸš§ Decision Gate: When to Switch to Approach B

### Blockers that Trigger Fallback

| Blocker | Description | Detection |
|---------|-------------|-----------|
| **MV3 CSP Violation** | React/Vite uses eval() or inline scripts | Build error or runtime CSP error |
| **Router Incompatibility** | React Router doesn't work in Side Panel | Navigation fails |
| **Bundle Size** | Vendored bundle > 5MB | Build output check |
| **Zustand Storage** | chrome.storage.local doesn't work with Zustand persist | Runtime error |
| **Lucide Icons** | Icons don't render in MV3 | Visual inspection |

### Detection Script

```javascript
// scripts/check-mv3-compatibility.js
const fs = require('fs');
const path = require('path');

async function checkCompatibility() {
  const issues = [];
  
  // Check bundle for eval()
  const bundle = fs.readFileSync('extension/dist/sidepanel.js', 'utf8');
  if (bundle.includes('eval(') || bundle.includes('new Function(')) {
    issues.push('CSP_VIOLATION: eval() or new Function() detected');
  }
  
  // Check bundle size
  const stats = fs.statSync('extension/dist/sidepanel.js');
  if (stats.size > 5 * 1024 * 1024) {
    issues.push(`BUNDLE_SIZE: ${(stats.size / 1024 / 1024).toFixed(2)}MB exceeds 5MB limit`);
  }
  
  // Check for inline scripts in HTML
  const html = fs.readFileSync('extension/dist/sidepanel.html', 'utf8');
  if (/<script[^>]*>(?!<\/script>)/.test(html)) {
    issues.push('CSP_VIOLATION: Inline script detected in HTML');
  }
  
  if (issues.length > 0) {
    console.log('âŒ MV3 Compatibility Issues:');
    issues.forEach(i => console.log(`  - ${i}`));
    console.log('\nâš ï¸ Consider switching to Approach B (Pixel-perfect Rebuild)');
    process.exit(1);
  } else {
    console.log('âœ… MV3 Compatibility Check Passed');
  }
}

checkCompatibility();
```

---

## ğŸ”„ Approach B: Pixel-perfect Rebuild (Fallback)

### When to Use

```
Use Approach B if:
1. Vendoring fails due to MV3 CSP constraints
2. React Router doesn't work in Side Panel context
3. Bundle size is too large
4. Too many import transformations needed
```

### Rebuild Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PIXEL-PERFECT REBUILD                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. Extract Design Tokens from Webapp                                   â”‚
â”‚     â”œâ”€â”€ Colors (primary, secondary, success, error, etc.)              â”‚
â”‚     â”œâ”€â”€ Typography (font sizes, weights, line heights)                 â”‚
â”‚     â”œâ”€â”€ Spacing (margins, paddings)                                    â”‚
â”‚     â”œâ”€â”€ Border radius                                                  â”‚
â”‚     â””â”€â”€ Shadows                                                        â”‚
â”‚                                                                          â”‚
â”‚  2. Create Extension-native Components                                  â”‚
â”‚     â”œâ”€â”€ Use same visual design                                         â”‚
â”‚     â”œâ”€â”€ Simplified for Side Panel context (400px width)               â”‚
â”‚     â”œâ”€â”€ No React Router (use simple state-based navigation)           â”‚
â”‚     â””â”€â”€ Direct chrome.* API integration                                â”‚
â”‚                                                                          â”‚
â”‚  3. Use Preact instead of React (smaller bundle)                       â”‚
â”‚     â”œâ”€â”€ 3KB vs 40KB                                                    â”‚
â”‚     â”œâ”€â”€ Same JSX syntax                                                â”‚
â”‚     â””â”€â”€ MV3 compatible                                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Tokens Extraction

```typescript
// extension/src/ui/tokens.ts
// Extracted from webapp inline styles

export const colors = {
  // Primary
  primary: {
    50: '#eff6ff',
    100: '#dbeafe',
    500: '#3b82f6',
    600: '#2563eb',
    700: '#1d4ed8'
  },
  
  // Success
  success: {
    50: '#f0fdf4',
    500: '#22c55e',
    600: '#16a34a'
  },
  
  // Error
  error: {
    50: '#fef2f2',
    500: '#ef4444',
    600: '#dc2626'
  },
  
  // Neutral
  gray: {
    50: '#f9fafb',
    100: '#f3f4f6',
    200: '#e5e7eb',
    300: '#d1d5db',
    400: '#9ca3af',
    500: '#6b7280',
    600: '#4b5563',
    700: '#374151',
    800: '#1f2937',
    900: '#111827'
  }
};

export const typography = {
  fontFamily: {
    sans: 'system-ui, -apple-system, sans-serif',
    arabic: 'Tajawal, system-ui, sans-serif'
  },
  fontSize: {
    xs: '0.75rem',
    sm: '0.875rem',
    base: '1rem',
    lg: '1.125rem',
    xl: '1.25rem',
    '2xl': '1.5rem'
  },
  fontWeight: {
    normal: '400',
    medium: '500',
    semibold: '600',
    bold: '700'
  }
};

export const spacing = {
  0: '0',
  1: '0.25rem',
  2: '0.5rem',
  3: '0.75rem',
  4: '1rem',
  5: '1.25rem',
  6: '1.5rem',
  8: '2rem'
};

export const borderRadius = {
  none: '0',
  sm: '0.125rem',
  md: '0.375rem',
  lg: '0.5rem',
  xl: '0.75rem',
  full: '9999px'
};
```

### Simplified Navigation (No React Router)

```typescript
// extension/src/ui/navigation.ts
type View = 'login' | 'main' | 'lead-detail' | 'settings';

interface NavigationState {
  currentView: View;
  params: Record<string, string>;
  history: View[];
}

// Simple state-based navigation
export function useExtensionNavigate() {
  const [nav, setNav] = useExtensionStore(state => state.navigation);
  
  const navigate = (view: View, params?: Record<string, string>) => {
    setNav({
      currentView: view,
      params: params || {},
      history: [...nav.history, nav.currentView]
    });
  };
  
  const goBack = () => {
    const history = [...nav.history];
    const previousView = history.pop() || 'main';
    setNav({
      currentView: previousView,
      params: {},
      history
    });
  };
  
  return { navigate, goBack, currentView: nav.currentView, params: nav.params };
}
```

### Component Rebuild Example

```tsx
// extension/src/ui/components/Button.tsx
// Rebuilt to match webapp Button exactly

import { colors, borderRadius, typography } from '../tokens';

interface ButtonProps {
  variant?: 'primary' | 'secondary' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  loading?: boolean;
  children: React.ReactNode;
  onClick?: () => void;
}

export function Button({
  variant = 'primary',
  size = 'md',
  disabled = false,
  loading = false,
  children,
  onClick
}: ButtonProps) {
  const baseStyles: React.CSSProperties = {
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: borderRadius.lg,
    fontWeight: typography.fontWeight.medium,
    transition: 'all 150ms',
    cursor: disabled ? 'not-allowed' : 'pointer',
    opacity: disabled ? 0.5 : 1
  };
  
  const sizeStyles: Record<string, React.CSSProperties> = {
    sm: { padding: '0.5rem 1rem', fontSize: typography.fontSize.sm },
    md: { padding: '0.75rem 1.5rem', fontSize: typography.fontSize.base },
    lg: { padding: '1rem 2rem', fontSize: typography.fontSize.lg }
  };
  
  const variantStyles: Record<string, React.CSSProperties> = {
    primary: {
      backgroundColor: colors.primary[600],
      color: 'white',
      border: 'none'
    },
    secondary: {
      backgroundColor: 'white',
      color: colors.gray[700],
      border: `1px solid ${colors.gray[300]}`
    },
    ghost: {
      backgroundColor: 'transparent',
      color: colors.gray[600],
      border: 'none'
    },
    danger: {
      backgroundColor: colors.error[600],
      color: 'white',
      border: 'none'
    }
  };
  
  return (
    <button
      style={{
        ...baseStyles,
        ...sizeStyles[size],
        ...variantStyles[variant]
      }}
      disabled={disabled || loading}
      onClick={onClick}
    >
      {loading && <Spinner />}
      {children}
    </button>
  );
}
```

---

## ğŸ“‹ Constraints Summary

### âœ… Allowed

| Item | Reason |
|------|--------|
| Copy files at build-time | No runtime dependency |
| Transform imports | Adapt to extension context |
| Use same Lucide icons | Already in webapp |
| Use Zustand | Already in webapp |
| Use TailwindCSS (build) | Already in webapp |

### âŒ Not Allowed

| Item | Reason |
|------|--------|
| Runtime imports from webapp | Extension must be independent |
| New UI libraries | Constraint from requirements |
| Shared node_modules | Separate builds |
| Dynamic imports from webapp | CSP violation risk |

### âš ï¸ Conditional (Needs Justification)

| Item | Condition |
|------|-----------|
| Preact instead of React | Only if React bundle too large |
| CSS-in-JS library | Only if TailwindCSS fails in MV3 |
| State management change | Only if Zustand fails with chrome.storage |

---

## ğŸ“Š File Structure

### After Vendoring (Approach A)

```
extension/
â”œâ”€â”€ manifest.json
â”œâ”€â”€ sidepanel.html
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background.ts           # Service worker
â”‚   â”œâ”€â”€ content.ts              # Content script
â”‚   â”œâ”€â”€ ui/                     # Vendored from webapp
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ PageHeader.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DataTable.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ WhatsAppModal.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â””â”€â”€ SidePanel.tsx   # Main side panel
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â””â”€â”€ logo.svg
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â””â”€â”€ index.css
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â””â”€â”€ useExtensionStore.ts
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useExtensionNavigate.ts
â”‚   â”‚   â””â”€â”€ useWebSocket.ts
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ client.ts
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ toast.ts
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ vendor-ui.js
â”‚   â””â”€â”€ transform-imports.js
â””â”€â”€ vite.config.ts
```

### After Rebuild (Approach B)

```
extension/
â”œâ”€â”€ manifest.json
â”œâ”€â”€ sidepanel.html
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background.ts
â”‚   â”œâ”€â”€ content.ts
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ components/         # Rebuilt components
â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ views/              # Rebuilt views
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginView.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MainView.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LeadView.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SettingsView.tsx
â”‚   â”‚   â”œâ”€â”€ tokens.ts           # Design tokens
â”‚   â”‚   â””â”€â”€ navigation.ts       # Simple navigation
â”‚   â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ utils/
â””â”€â”€ vite.config.ts
```

---

## ğŸ”„ Migration Process

### Phase 1: Preparation

```
Week 1:
â”œâ”€â”€ Set up extension project structure
â”œâ”€â”€ Configure Vite for MV3
â”œâ”€â”€ Create vendoring scripts
â”œâ”€â”€ Create transformation scripts
â””â”€â”€ Set up CI for extension build
```

### Phase 2: Vendoring Attempt

```
Week 2:
â”œâ”€â”€ Run vendor-ui.js
â”œâ”€â”€ Run transform-imports.js
â”œâ”€â”€ Fix import errors manually
â”œâ”€â”€ Build extension
â”œâ”€â”€ Run MV3 compatibility check
â””â”€â”€ Decision: Continue with A or switch to B
```

### Phase 3A: Complete Vendoring (if successful)

```
Week 3:
â”œâ”€â”€ Create useExtensionStore
â”œâ”€â”€ Integrate with chrome.* APIs
â”œâ”€â”€ Test all components
â”œâ”€â”€ Fix styling issues
â””â”€â”€ Final build and test
```

### Phase 3B: Pixel-perfect Rebuild (if needed)

```
Week 3-4:
â”œâ”€â”€ Extract design tokens
â”œâ”€â”€ Rebuild core components
â”œâ”€â”€ Rebuild views
â”œâ”€â”€ Integrate with chrome.* APIs
â””â”€â”€ Visual comparison testing
```

---

## ğŸ”„ CI Sync Check (CF-10 fix)

### GitHub Action

```yaml
# .github/workflows/extension-ui-sync.yml
name: Extension UI Sync Check

on:
  push:
    paths:
      - 'web/src/components/**'
      - 'web/src/pages/ExtensionSidePanel.tsx'
      - 'extension/src/ui/**'
  pull_request:
    paths:
      - 'web/src/components/**'
      - 'web/src/pages/ExtensionSidePanel.tsx'
      - 'extension/src/ui/**'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run vendor script in check mode
        run: node scripts/vendor-ui.js --check-only
        
      - name: Fail if out of sync
        run: |
          if [ -f .ui-out-of-sync ]; then
            echo "âŒ Extension UI is out of sync with Web UI"
            echo "Run: npm run vendor-ui"
            cat .ui-out-of-sync
            exit 1
          fi
          echo "âœ… Extension UI is in sync"
```

### Check-only Mode Implementation

```javascript
// scripts/vendor-ui.js

const CHECK_ONLY = process.argv.includes('--check-only');

async function main() {
  const diffs = [];
  
  for (const [webPath, extPath] of FILE_MAPPINGS) {
    const webContent = await fs.readFile(webPath, 'utf-8').catch(() => null);
    const extContent = await fs.readFile(extPath, 'utf-8').catch(() => null);
    
    if (!webContent) {
      console.warn(`âš ï¸ Web file not found: ${webPath}`);
      continue;
    }
    
    if (!extContent) {
      diffs.push(`MISSING: ${extPath} (source: ${webPath})`);
      continue;
    }
    
    // Compare after normalizing imports
    const normalizedWeb = normalizeImports(webContent);
    const normalizedExt = normalizeImports(extContent);
    
    if (normalizedWeb !== normalizedExt) {
      diffs.push(`CHANGED: ${webPath} â†’ ${extPath}`);
    }
  }
  
  if (CHECK_ONLY) {
    if (diffs.length > 0) {
      await fs.writeFile('.ui-out-of-sync', diffs.join('\n'));
      console.error(`âŒ ${diffs.length} files out of sync`);
      process.exit(1);
    }
    console.log('âœ… All files in sync');
    process.exit(0);
  }
  
  // Normal mode: copy files
  await copyFiles();
}
```

### Pre-commit Hook (Optional)

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check if any vendored files changed
if git diff --cached --name-only | grep -q "^web/src/components/"; then
  echo "ğŸ” Checking Extension UI sync..."
  npm run vendor-ui:check || {
    echo "âŒ Extension UI out of sync. Run: npm run vendor-ui"
    exit 1
  }
fi
```

### Package.json Scripts

```json
{
  "scripts": {
    "vendor-ui": "node scripts/vendor-ui.js",
    "vendor-ui:check": "node scripts/vendor-ui.js --check-only",
    "vendor-ui:watch": "node scripts/vendor-ui.js --watch"
  }
}
```

---

## â“ Open Questions

| # | Question | Verification Method |
|---|----------|---------------------|
| 1 | Ù‡Ù„ TailwindCSS ÙŠØ¹Ù…Ù„ Ù…Ø¹ MV3 CSPØŸ | Build and test |
| 2 | Ù‡Ù„ Zustand persist ÙŠØ¹Ù…Ù„ Ù…Ø¹ chrome.storageØŸ | Runtime test |
| 3 | Ù…Ø§ Ø­Ø¬Ù… Bundle Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ Ù„Ù„Ù€ ExtensionØŸ | Chrome Web Store guidelines |
| 4 | Ù‡Ù„ Ù†Ø­ØªØ§Ø¬ i18n ÙÙŠ Ø§Ù„Ù€ ExtensionØŸ | Product decision |
| 5 | Ù‡Ù„ Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù€ fonts Ø£Ù… system fontsØŸ | Design decision |

---

## ğŸ“ Documentation of Failures (If Approach B Used)

> **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙŠÙÙ…Ù„Ø£ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙØ´Ù„ Approach A

### Failure Log Template

```markdown
## Vendoring Failure Report

**Date:** [DATE]
**Attempted By:** [NAME]

### What Failed
[Description of the failure]

### Error Messages
```
[Paste error messages here]
```

### Root Cause
[Analysis of why it failed]

### Components Affected
- [ ] Component 1
- [ ] Component 2

### Decision
Switch to Approach B because: [Reason]

### What Was Rebuilt
| Component | Original | Rebuilt | Differences |
|-----------|----------|---------|-------------|
| Button | webapp/Button.tsx | extension/Button.tsx | Simplified props |
```

---

> **Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:** [13-EXTENSION_API_MAPPING.md](./13-EXTENSION_API_MAPPING.md)
