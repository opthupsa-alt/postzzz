# ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª - Analysis Pack v2.1

> **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.1.0  
> **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** ÙŠÙ†Ø§ÙŠØ± 2026  
> **Ø§Ù„ØºØ±Ø¶:** ØªØ¹Ø±ÙŠÙ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ£Ø¹Ù„Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Øª

---

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙŠÙØ¹Ø±Ù‘Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Plans) ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ (Quotas) ÙˆØ£Ø¹Ù„Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Øª (Feature Flags) Ù„Ù†Ø¸Ø§Ù… Ù„ÙŠØ¯Ø²Ø²Ø² SaaS.

---

## ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SUBSCRIPTION PLANS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   FREE   â”‚  â”‚ STARTER  â”‚  â”‚   PRO    â”‚  â”‚  ENTERPRISE  â”‚            â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚              â”‚            â”‚
â”‚  â”‚  Ù…Ø¬Ø§Ù†ÙŠ   â”‚  â”‚  Ø£Ø³Ø§Ø³ÙŠ   â”‚  â”‚ Ø§Ø­ØªØ±Ø§ÙÙŠ  â”‚  â”‚   Ù…Ø¤Ø³Ø³ÙŠ     â”‚            â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚              â”‚            â”‚
â”‚  â”‚  0 Ø±.Ø³   â”‚  â”‚ 99 Ø±.Ø³   â”‚  â”‚ 299 Ø±.Ø³  â”‚  â”‚   Ù…Ø®ØµØµ      â”‚            â”‚
â”‚  â”‚  /Ø´Ù‡Ø±    â”‚  â”‚  /Ø´Ù‡Ø±    â”‚  â”‚  /Ø´Ù‡Ø±    â”‚  â”‚              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª

| Ø§Ù„Ø¨Ø§Ù‚Ø© | Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ | Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ | Ø§Ù„ÙˆØµÙ |
|--------|-------------|--------------|-------|
| **FREE** | 0 Ø±.Ø³ | 0 Ø±.Ø³ | Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØµØºÙŠØ±Ø© |
| **STARTER** | 99 Ø±.Ø³ | 990 Ø±.Ø³ (Ø´Ù‡Ø±ÙŠÙ† Ù…Ø¬Ø§Ù†Ø§Ù‹) | Ù„Ù„ÙØ±Ù‚ Ø§Ù„ØµØºÙŠØ±Ø© |
| **PRO** | 299 Ø±.Ø³ | 2,990 Ø±.Ø³ (Ø´Ù‡Ø±ÙŠÙ† Ù…Ø¬Ø§Ù†Ø§Ù‹) | Ù„Ù„ÙØ±Ù‚ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© |
| **ENTERPRISE** | Ù…Ø®ØµØµ | Ù…Ø®ØµØµ | Ù„Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© |

---

## ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯ (Quotas)

### Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Seats)** | 1 | 5 | 20 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©** | OWNER ÙÙ‚Ø· | Ø§Ù„ÙƒÙ„ | Ø§Ù„ÙƒÙ„ | Ø§Ù„ÙƒÙ„ + Ù…Ø®ØµØµ |

### Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Leads)

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡** | 100 | 1,000 | 10,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø´Ù‡Ø±** | 50 | 500 | 5,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **ØªØµØ¯ÙŠØ±/Ø´Ù‡Ø±** | 50 | 500 | 5,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |

### Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø« (Search)

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø­Ø«/Ø´Ù‡Ø±** | 10 | 100 | 1,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ù†ØªØ§Ø¦Ø¬/Ø¨Ø­Ø«** | 20 | 50 | 100 | 200 |
| **Ø¨Ø­Ø« Ù…ØªØ²Ø§Ù…Ù†** | 1 | 2 | 5 | 10 |

### Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø¯Ù„Ø© (Evidence)

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Ø£Ø¯Ù„Ø©/Ø¹Ù…ÙŠÙ„** | 10 | 50 | 100 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Survey/Ø´Ù‡Ø±** | 20 | 200 | 2,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ø­Ø¬Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ†** | 100MB | 1GB | 10GB | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |

### Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Reports)

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **ØªÙ‚Ø§Ø±ÙŠØ± AI/Ø´Ù‡Ø±** | 5 | 50 | 500 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **ØªØµØ¯ÙŠØ± PDF/Ø´Ù‡Ø±** | 5 | 50 | 500 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |

### Ø­Ø¯ÙˆØ¯ WhatsApp

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Ø±Ø³Ø§Ø¦Ù„/Ø´Ù‡Ø±** | 50 | 500 | 5,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ø±Ø³Ø§Ø¦Ù„ Ø¬Ù…Ø§Ø¹ÙŠØ©/ÙŠÙˆÙ…** | âœ— | 50 | 500 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø®ØµØµØ©** | 1 | 5 | 20 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |

### Ø­Ø¯ÙˆØ¯ Jobs

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Jobs Ù…ØªØ²Ø§Ù…Ù†Ø©** | 1 | 3 | 10 | 50 |
| **Jobs/Ø³Ø§Ø¹Ø©** | 10 | 50 | 200 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Retry attempts** | 1 | 2 | 3 | 5 |

### Ø­Ø¯ÙˆØ¯ Extension

| Ø§Ù„Ø­Ø¯ | FREE | STARTER | PRO | ENTERPRISE |
|------|:----:|:-------:|:---:|:----------:|
| **Reveal/Ø´Ù‡Ø±** | 10 | 100 | 1,000 | ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ |
| **Connectors** | google_maps ÙÙ‚Ø· | Ø§Ù„ÙƒÙ„ | Ø§Ù„ÙƒÙ„ | Ø§Ù„ÙƒÙ„ + Ù…Ø®ØµØµ |

---

## ğŸš© Ø£Ø¹Ù„Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Øª (Feature Flags)

### Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©

| Feature Flag | FREE | STARTER | PRO | ENTERPRISE |
|--------------|:----:|:-------:|:---:|:----------:|
| `feature_search` | âœ“ | âœ“ | âœ“ | âœ“ |
| `feature_survey` | âœ“ | âœ“ | âœ“ | âœ“ |
| `feature_evidence` | âœ“ | âœ“ | âœ“ | âœ“ |
| `feature_reports` | âœ— | âœ“ | âœ“ | âœ“ |
| `feature_ai_reports` | âœ— | âœ— | âœ“ | âœ“ |
| `feature_whatsapp` | âœ— | âœ“ | âœ“ | âœ“ |
| `feature_whatsapp_bulk` | âœ— | âœ— | âœ“ | âœ“ |
| `feature_reveal` | âœ— | âœ“ | âœ“ | âœ“ |
| `feature_export` | âœ— | âœ“ | âœ“ | âœ“ |
| `feature_import` | âœ“ | âœ“ | âœ“ | âœ“ |
| `feature_lists` | âœ“ | âœ“ | âœ“ | âœ“ |
| `feature_team` | âœ— | âœ“ | âœ“ | âœ“ |
| `feature_integrations` | âœ— | âœ— | âœ“ | âœ“ |
| `feature_api_keys` | âœ— | âœ— | âœ“ | âœ“ |
| `feature_audit_logs` | âœ— | âœ— | âœ“ | âœ“ |
| `feature_custom_roles` | âœ— | âœ— | âœ— | âœ“ |
| `feature_sso` | âœ— | âœ— | âœ— | âœ“ |
| `feature_dedicated_support` | âœ— | âœ— | âœ— | âœ“ |

### Connectors Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©

| Connector Flag | FREE | STARTER | PRO | ENTERPRISE |
|----------------|:----:|:-------:|:---:|:----------:|
| `connector_google_maps` | âœ“ | âœ“ | âœ“ | âœ“ |
| `connector_web_search` | âœ— | âœ“ | âœ“ | âœ“ |
| `connector_website_crawl` | âœ— | âœ“ | âœ“ | âœ“ |
| `connector_social_public` | âœ— | âœ— | âœ“ | âœ“ |
| `connector_custom` | âœ— | âœ— | âœ— | âœ“ |

---

## ğŸ—„ï¸ Database Schema

### Plans Table

```sql
CREATE TABLE plans (
  id VARCHAR(20) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  name_ar VARCHAR(100) NOT NULL,
  description TEXT,
  description_ar TEXT,
  price_monthly DECIMAL(10,2) NOT NULL,
  price_yearly DECIMAL(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'SAR',
  is_active BOOLEAN DEFAULT TRUE,
  is_public BOOLEAN DEFAULT TRUE,  -- Show in pricing page
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO plans (id, name, name_ar, price_monthly, price_yearly) VALUES
  ('FREE', 'Free', 'Ù…Ø¬Ø§Ù†ÙŠ', 0, 0),
  ('STARTER', 'Starter', 'Ø£Ø³Ø§Ø³ÙŠ', 99, 990),
  ('PRO', 'Pro', 'Ø§Ø­ØªØ±Ø§ÙÙŠ', 299, 2990),
  ('ENTERPRISE', 'Enterprise', 'Ù…Ø¤Ø³Ø³ÙŠ', 0, 0);  -- Custom pricing
```

### Plan Quotas Table

```sql
CREATE TABLE plan_quotas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id VARCHAR(20) REFERENCES plans(id),
  quota_key VARCHAR(50) NOT NULL,
  quota_value INTEGER NOT NULL,  -- -1 = unlimited
  period VARCHAR(20) DEFAULT 'MONTHLY',  -- MONTHLY, DAILY, TOTAL
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(plan_id, quota_key)
);

-- Example quotas for STARTER plan
INSERT INTO plan_quotas (plan_id, quota_key, quota_value, period) VALUES
  ('STARTER', 'seats', 5, 'TOTAL'),
  ('STARTER', 'leads_total', 1000, 'TOTAL'),
  ('STARTER', 'leads_import', 500, 'MONTHLY'),
  ('STARTER', 'leads_export', 500, 'MONTHLY'),
  ('STARTER', 'searches', 100, 'MONTHLY'),
  ('STARTER', 'search_results', 50, 'TOTAL'),
  ('STARTER', 'concurrent_jobs', 3, 'TOTAL'),
  ('STARTER', 'jobs_per_hour', 50, 'HOURLY'),
  ('STARTER', 'evidence_per_lead', 50, 'TOTAL'),
  ('STARTER', 'surveys', 200, 'MONTHLY'),
  ('STARTER', 'storage_mb', 1024, 'TOTAL'),
  ('STARTER', 'ai_reports', 50, 'MONTHLY'),
  ('STARTER', 'whatsapp_messages', 500, 'MONTHLY'),
  ('STARTER', 'whatsapp_bulk_daily', 50, 'DAILY'),
  ('STARTER', 'whatsapp_templates', 5, 'TOTAL'),
  ('STARTER', 'reveals', 100, 'MONTHLY');
```

### Plan Features Table

```sql
CREATE TABLE plan_features (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id VARCHAR(20) REFERENCES plans(id),
  feature_key VARCHAR(50) NOT NULL,
  is_enabled BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(plan_id, feature_key)
);

-- Example features for STARTER plan
INSERT INTO plan_features (plan_id, feature_key, is_enabled) VALUES
  ('STARTER', 'feature_search', TRUE),
  ('STARTER', 'feature_survey', TRUE),
  ('STARTER', 'feature_evidence', TRUE),
  ('STARTER', 'feature_reports', TRUE),
  ('STARTER', 'feature_ai_reports', FALSE),
  ('STARTER', 'feature_whatsapp', TRUE),
  ('STARTER', 'feature_whatsapp_bulk', FALSE),
  ('STARTER', 'feature_reveal', TRUE),
  ('STARTER', 'feature_export', TRUE),
  ('STARTER', 'feature_import', TRUE),
  ('STARTER', 'feature_lists', TRUE),
  ('STARTER', 'feature_team', TRUE),
  ('STARTER', 'feature_integrations', FALSE),
  ('STARTER', 'feature_api_keys', FALSE),
  ('STARTER', 'feature_audit_logs', FALSE),
  ('STARTER', 'connector_google_maps', TRUE),
  ('STARTER', 'connector_web_search', TRUE),
  ('STARTER', 'connector_website_crawl', TRUE),
  ('STARTER', 'connector_social_public', FALSE);
```

### Subscriptions Table

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  plan_id VARCHAR(20) REFERENCES plans(id),
  status VARCHAR(20) DEFAULT 'ACTIVE',
  billing_cycle VARCHAR(20) DEFAULT 'MONTHLY',  -- MONTHLY, YEARLY
  current_period_start TIMESTAMP NOT NULL,
  current_period_end TIMESTAMP NOT NULL,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  canceled_at TIMESTAMP,
  trial_start TIMESTAMP,
  trial_end TIMESTAMP,
  external_id VARCHAR(255),  -- Stripe/Payment provider ID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id)
);

CREATE TYPE subscription_status AS ENUM (
  'TRIALING',
  'ACTIVE',
  'PAST_DUE',
  'CANCELED',
  'UNPAID',
  'PAUSED'
);
```

### Usage Counters Table

```sql
CREATE TABLE usage_counters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  counter_key VARCHAR(50) NOT NULL,
  counter_value INTEGER DEFAULT 0,
  period_start TIMESTAMP NOT NULL,
  period_end TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, counter_key, period_start)
);

CREATE INDEX idx_usage_counters_tenant ON usage_counters(tenant_id);
CREATE INDEX idx_usage_counters_period ON usage_counters(period_start, period_end);
```

### Tenant Feature Overrides Table

```sql
-- For custom Enterprise features or temporary overrides
CREATE TABLE tenant_feature_overrides (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  feature_key VARCHAR(50) NOT NULL,
  is_enabled BOOLEAN NOT NULL,
  reason TEXT,  -- Why override was applied
  expires_at TIMESTAMP,  -- Optional expiration
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, feature_key)
);
```

---

## ğŸ” Quota Check Implementation

```typescript
interface QuotaCheck {
  tenantId: string;
  quotaKey: string;
  increment?: number;  // How much to add (default 1)
}

interface QuotaResult {
  allowed: boolean;
  current: number;
  limit: number;
  remaining: number;
  resetsAt?: Date;
}

async function checkQuota(check: QuotaCheck): Promise<QuotaResult> {
  const subscription = await getSubscription(check.tenantId);
  const planQuota = await getPlanQuota(subscription.planId, check.quotaKey);
  
  if (planQuota.quotaValue === -1) {
    // Unlimited
    return {
      allowed: true,
      current: 0,
      limit: -1,
      remaining: -1
    };
  }
  
  const period = getPeriodBounds(planQuota.period);
  const currentUsage = await getCurrentUsage(
    check.tenantId,
    check.quotaKey,
    period.start,
    period.end
  );
  
  const increment = check.increment ?? 1;
  const newValue = currentUsage + increment;
  const allowed = newValue <= planQuota.quotaValue;
  
  return {
    allowed,
    current: currentUsage,
    limit: planQuota.quotaValue,
    remaining: Math.max(0, planQuota.quotaValue - currentUsage),
    resetsAt: period.end
  };
}

async function incrementUsage(
  tenantId: string,
  quotaKey: string,
  amount: number = 1
): Promise<void> {
  const period = getPeriodBounds('MONTHLY');
  
  await db.query(`
    INSERT INTO usage_counters (tenant_id, counter_key, counter_value, period_start, period_end)
    VALUES ($1, $2, $3, $4, $5)
    ON CONFLICT (tenant_id, counter_key, period_start)
    DO UPDATE SET counter_value = usage_counters.counter_value + $3, updated_at = NOW()
  `, [tenantId, quotaKey, amount, period.start, period.end]);
}
```

---

## ğŸš© Feature Flag Check Implementation

```typescript
async function isFeatureEnabled(
  tenantId: string,
  featureKey: string
): Promise<boolean> {
  // 1. Check tenant-specific override first
  const override = await getTenantFeatureOverride(tenantId, featureKey);
  if (override) {
    // Check if override expired
    if (override.expiresAt && override.expiresAt < new Date()) {
      await deleteOverride(override.id);
    } else {
      return override.isEnabled;
    }
  }
  
  // 2. Check plan features
  const subscription = await getSubscription(tenantId);
  const planFeature = await getPlanFeature(subscription.planId, featureKey);
  
  return planFeature?.isEnabled ?? false;
}

// Middleware for feature-gated endpoints
function requireFeature(featureKey: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const tenantId = req.tenantId;
    const enabled = await isFeatureEnabled(tenantId, featureKey);
    
    if (!enabled) {
      return res.status(403).json({
        success: false,
        error: {
          code: 'FEATURE_NOT_AVAILABLE',
          message: 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø¨Ø§Ù‚ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
          feature: featureKey,
          upgradeUrl: '/app/billing/upgrade'
        }
      });
    }
    
    next();
  };
}
```

---

## ğŸ“Š Usage Dashboard Data

```typescript
interface UsageDashboard {
  plan: {
    id: string;
    name: string;
    nameAr: string;
  };
  subscription: {
    status: string;
    currentPeriodEnd: Date;
    cancelAtPeriodEnd: boolean;
  };
  usage: {
    seats: { used: number; limit: number };
    leads: { used: number; limit: number };
    searches: { used: number; limit: number; resetsAt: Date };
    surveys: { used: number; limit: number; resetsAt: Date };
    aiReports: { used: number; limit: number; resetsAt: Date };
    whatsappMessages: { used: number; limit: number; resetsAt: Date };
    reveals: { used: number; limit: number; resetsAt: Date };
    storage: { usedMb: number; limitMb: number };
  };
  features: {
    [key: string]: boolean;
  };
}

// API Endpoint
// GET /api/billing/usage
async function getUsageDashboard(tenantId: string): Promise<UsageDashboard> {
  // ... implementation
}
```

---

## ğŸ”„ Upgrade/Downgrade Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UPGRADE/DOWNGRADE FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  UPGRADE (Immediate)                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  1. User selects new plan                                               â”‚
â”‚  2. Calculate prorated amount                                           â”‚
â”‚  3. Charge difference                                                   â”‚
â”‚  4. Update subscription immediately                                     â”‚
â”‚  5. New features available instantly                                    â”‚
â”‚  6. New quotas apply immediately                                        â”‚
â”‚                                                                          â”‚
â”‚  DOWNGRADE (End of Period)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  1. User selects new plan                                               â”‚
â”‚  2. Mark subscription for downgrade at period end                       â”‚
â”‚  3. Show warning if current usage exceeds new limits                    â”‚
â”‚  4. At period end:                                                      â”‚
â”‚     - Switch to new plan                                                â”‚
â”‚     - Features restricted                                               â”‚
â”‚     - Data NOT deleted (just read-only if over limit)                   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Downgrade Warnings

```typescript
interface DowngradeWarning {
  quotaKey: string;
  currentUsage: number;
  newLimit: number;
  action: 'READ_ONLY' | 'OLDEST_ARCHIVED' | 'MANUAL_DELETE';
  message: string;
}

async function getDowngradeWarnings(
  tenantId: string,
  newPlanId: string
): Promise<DowngradeWarning[]> {
  const warnings: DowngradeWarning[] = [];
  
  // Check leads
  const leadsCount = await getLeadsCount(tenantId);
  const newLeadsLimit = await getPlanQuota(newPlanId, 'leads_total');
  if (leadsCount > newLeadsLimit.quotaValue) {
    warnings.push({
      quotaKey: 'leads_total',
      currentUsage: leadsCount,
      newLimit: newLeadsLimit.quotaValue,
      action: 'READ_ONLY',
      message: `Ù„Ø¯ÙŠÙƒ ${leadsCount} Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªØ³Ù…Ø­ Ø¨Ù€ ${newLeadsLimit.quotaValue} ÙÙ‚Ø·. Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯.`
    });
  }
  
  // Check seats
  const activeMembers = await getActiveMembersCount(tenantId);
  const newSeatsLimit = await getPlanQuota(newPlanId, 'seats');
  if (activeMembers > newSeatsLimit.quotaValue) {
    warnings.push({
      quotaKey: 'seats',
      currentUsage: activeMembers,
      newLimit: newSeatsLimit.quotaValue,
      action: 'MANUAL_DELETE',
      message: `Ù„Ø¯ÙŠÙƒ ${activeMembers} Ø¹Ø¶Ùˆ Ù†Ø´Ø·ØŒ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªØ³Ù…Ø­ Ø¨Ù€ ${newSeatsLimit.quotaValue} ÙÙ‚Ø·. ÙŠØ¬Ø¨ Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„ØªØ®ÙÙŠØ¶.`
    });
  }
  
  return warnings;
}
```

---

## ğŸ Trial Period

```typescript
const TRIAL_DAYS = 14;
const TRIAL_PLAN = 'PRO';  // Trial gives PRO features

async function startTrial(tenantId: string): Promise<void> {
  const now = new Date();
  const trialEnd = addDays(now, TRIAL_DAYS);
  
  await db.query(`
    INSERT INTO subscriptions (tenant_id, plan_id, status, trial_start, trial_end, current_period_start, current_period_end)
    VALUES ($1, $2, 'TRIALING', $3, $4, $3, $4)
  `, [tenantId, TRIAL_PLAN, now, trialEnd]);
}

async function checkTrialExpiry(): Promise<void> {
  // Cron job: runs daily
  const expiredTrials = await db.query(`
    SELECT * FROM subscriptions
    WHERE status = 'TRIALING' AND trial_end < NOW()
  `);
  
  for (const sub of expiredTrials) {
    // Downgrade to FREE
    await updateSubscription(sub.id, {
      planId: 'FREE',
      status: 'ACTIVE',
      currentPeriodStart: new Date(),
      currentPeriodEnd: addMonths(new Date(), 1)
    });
    
    // Notify user
    await sendTrialExpiredEmail(sub.tenantId);
  }
}
```

---

## ğŸ“ˆ Billing Events (Audit)

| Event | Trigger | Data Logged |
|-------|---------|-------------|
| `SUBSCRIPTION_CREATED` | New subscription | planId, billingCycle |
| `SUBSCRIPTION_UPGRADED` | Plan upgrade | oldPlan, newPlan, proratedAmount |
| `SUBSCRIPTION_DOWNGRADED` | Plan downgrade scheduled | oldPlan, newPlan, effectiveDate |
| `SUBSCRIPTION_CANCELED` | Cancellation | reason, effectiveDate |
| `SUBSCRIPTION_RENEWED` | Auto-renewal | planId, amount |
| `PAYMENT_SUCCEEDED` | Payment processed | amount, invoiceId |
| `PAYMENT_FAILED` | Payment failed | reason, retryDate |
| `TRIAL_STARTED` | Trial begins | trialEnd |
| `TRIAL_ENDED` | Trial expires | convertedToPlan |
| `QUOTA_EXCEEDED` | Limit reached | quotaKey, limit |
| `FEATURE_ACCESSED` | Feature used | featureKey |

---

## â“ Open Questions

| # | Ø§Ù„Ø³Ø¤Ø§Ù„ | Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù‚Ù‚ |
|---|--------|--------------|
| 1 | Ù‡Ù„ Ù†Ø­ØªØ§Ø¬ Ø¨Ø§Ù‚Ø© Ø³Ù†ÙˆÙŠØ© Ø¨Ø®ØµÙ… Ø£ÙƒØ¨Ø±ØŸ | Business decision |
| 2 | Ù…Ø§ Ù…Ø¯Ø© Trial Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ | A/B testing |
| 3 | Ù‡Ù„ Ù†Ø³Ù…Ø­ Ø¨Ù€ Add-ons (Ø´Ø±Ø§Ø¡ Ø­Ø¯ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ©)ØŸ | Product decision |
| 4 | ÙƒÙŠÙ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©ØŸ | Legal/Finance review |

---

> **Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:** [15-MULTITENANCY_RBAC_MATRIX.md](./15-MULTITENANCY_RBAC_MATRIX.md)  
> **Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:** [02-DATA-MODEL.md](./02-DATA-MODEL.md) (Ù…Ø­Ø¯Ù‘Ø«)
