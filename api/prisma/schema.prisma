generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Tenant {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  planId      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  auditLogs   AuditLog[]
  invites     Invite[]
  jobs        Job[]
  memberships Membership[]
  users       User[]

  @@map("tenants")
}

model User {
  id              String       @id @default(uuid())
  email           String       @unique
  passwordHash    String
  name            String
  avatarUrl       String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  defaultTenantId String?
  auditLogs       AuditLog[]
  invitesSent     Invite[]     @relation("InviteSender")
  jobs            Job[]
  memberships     Membership[]
  defaultTenant   Tenant?      @relation(fields: [defaultTenantId], references: [id])

  @@map("users")
}

model Membership {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      Role     @default(SALES)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("memberships")
}

model Invite {
  id         String       @id @default(uuid())
  email      String
  tenantId   String
  role       Role         @default(SALES)
  token      String       @unique
  status     InviteStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime     @default(now())
  acceptedAt DateTime?
  inviterId  String
  inviter    User         @relation("InviteSender", fields: [inviterId], references: [id])
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([email, status])
  @@map("invites")
}

model Job {
  id              String     @id @default(uuid())
  tenantId        String
  type            String
  status          JobStatus  @default(PENDING)
  progress        Int        @default(0)
  errorCode       String?
  needsUserAction Boolean    @default(false)
  input           Json?
  output          Json?
  error           Json?
  createdAt       DateTime   @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  createdById     String
  assignedAgentId String?
  evidence        Evidence[]
  jobLogs         JobLog[]
  createdBy       User       @relation(fields: [createdById], references: [id])
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([assignedAgentId, status])
  @@map("jobs")
}

model JobLog {
  id        String   @id @default(uuid())
  jobId     String
  level     String   @default("INFO")
  message   String
  metadata  Json?
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
  @@map("job_logs")
}

model Evidence {
  id          String   @id @default(uuid())
  jobId       String
  type        String
  title       String
  source      String
  url         String?
  snippet     String
  confidence  String
  hash        String
  sizeBytes   Int
  collectedAt DateTime
  createdAt   DateTime @default(now())
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([hash])
  @@map("evidence")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  price       Int
  maxUsers    Int
  maxLeads    Int
  maxSearches Int
  maxMessages Int
  features    Json
  createdAt   DateTime @default(now())

  @@map("plans")
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  SALES
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
