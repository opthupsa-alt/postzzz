generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model Tenant {
  id            String         @id @default(uuid())
  name          String
  slug          String         @unique
  planId        String?
  status        TenantStatus   @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  auditLogs     AuditLog[]
  invites       Invite[]
  jobs          Job[]
  leads         Lead[]
  lists         List[]
  memberships   Membership[]
  reports       Report[]
  subscription  Subscription?
  usageCounters UsageCounter[]
  users         User[]

  @@map("tenants")
}

model User {
  id              String       @id @default(uuid())
  email           String       @unique
  passwordHash    String
  name            String
  avatarUrl       String?
  isSuperAdmin    Boolean      @default(false)
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  defaultTenantId String?
  auditLogs       AuditLog[]
  invitesSent     Invite[]     @relation("InviteSender")
  jobs            Job[]
  leads           Lead[]
  lists           List[]
  memberships     Membership[]
  reports         Report[]
  defaultTenant   Tenant?      @relation(fields: [defaultTenantId], references: [id])
  extensionSettings ExtensionSettings?

  @@map("users")
}

model Membership {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      Role     @default(SALES)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("memberships")
}

model Invite {
  id         String       @id @default(uuid())
  email      String
  tenantId   String
  role       Role         @default(SALES)
  token      String       @unique
  status     InviteStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime     @default(now())
  acceptedAt DateTime?
  inviterId  String
  inviter    User         @relation("InviteSender", fields: [inviterId], references: [id])
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([email, status])
  @@map("invites")
}

model Job {
  id              String     @id @default(uuid())
  tenantId        String
  type            String
  status          JobStatus  @default(PENDING)
  progress        Int        @default(0)
  errorCode       String?
  needsUserAction Boolean    @default(false)
  input           Json?
  output          Json?
  error           Json?
  createdAt       DateTime   @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  createdById     String
  assignedAgentId String?
  evidence        Evidence[]
  jobLogs         JobLog[]
  leads           Lead[]
  createdBy       User       @relation(fields: [createdById], references: [id])
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([assignedAgentId, status])
  @@map("jobs")
}

model JobLog {
  id        String   @id @default(uuid())
  jobId     String
  level     String   @default("INFO")
  message   String
  metadata  Json?
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
  @@map("job_logs")
}

model Evidence {
  id          String   @id @default(uuid())
  jobId       String
  type        String
  title       String
  source      String
  url         String?
  snippet     String
  confidence  String
  hash        String
  sizeBytes   Int
  collectedAt DateTime
  createdAt   DateTime @default(now())
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([hash])
  @@map("evidence")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
  @@index([userId, createdAt])
  @@map("audit_logs")
}


enum Role {
  OWNER
  ADMIN
  MANAGER
  SALES
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

model Lead {
  id           String     @id @default(uuid())
  tenantId     String
  companyName  String
  industry     String?
  city         String?
  address      String?
  phone        String?
  email        String?
  website      String?
  status       LeadStatus @default(NEW)
  source       String?
  notes        String?
  jobId        String?
  metadata     Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  createdById  String

  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy    User       @relation(fields: [createdById], references: [id])
  job          Job?       @relation(fields: [jobId], references: [id])
  lists        LeadList[]
  reports      Report[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("leads")
}

model List {
  id          String     @id @default(uuid())
  tenantId    String
  name        String
  description String?
  color       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdById String

  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy   User       @relation(fields: [createdById], references: [id])
  leads       LeadList[]

  @@index([tenantId])
  @@map("lists")
}

model LeadList {
  id        String   @id @default(uuid())
  leadId    String
  listId    String
  addedAt   DateTime @default(now())

  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  list      List     @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([leadId, listId])
  @@index([listId])
  @@map("lead_lists")
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum ReportType {
  LEAD_ANALYSIS
  COMPANY_PROFILE
  MARKET_RESEARCH
  COMPETITOR_ANALYSIS
}

model Report {
  id          String       @id @default(uuid())
  tenantId    String
  leadId      String?
  type        ReportType
  status      ReportStatus @default(PENDING)
  title       String
  content     Json?
  pdfUrl      String?
  error       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  completedAt DateTime?
  createdById String

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead        Lead?        @relation(fields: [leadId], references: [id])
  createdBy   User         @relation(fields: [createdById], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([leadId])
  @@map("reports")
}

// ==================== Plans & Subscriptions ====================

model Plan {
  id              String         @id @default(uuid())
  name            String         @unique
  nameAr          String
  description     String?
  descriptionAr   String?
  price           Decimal        @db.Decimal(10, 2)
  yearlyPrice     Decimal        @db.Decimal(10, 2)
  currency        String         @default("SAR")
  
  // Limits (-1 = unlimited)
  seatsLimit      Int            @default(1)
  leadsLimit      Int            @default(100)
  searchesLimit   Int            @default(10)
  messagesLimit   Int            @default(50)
  
  // Features (JSON array of feature keys)
  features        String[]       @default([])
  
  isActive        Boolean        @default(true)
  sortOrder       Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  subscriptions   Subscription[]

  @@map("plans")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Subscription {
  id                  String             @id @default(uuid())
  tenantId            String             @unique
  planId              String
  status              SubscriptionStatus @default(ACTIVE)
  billingCycle        BillingCycle       @default(MONTHLY)
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime
  cancelAtPeriodEnd   Boolean            @default(false)
  trialEndsAt         DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                Plan               @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@map("subscriptions")
}

enum UsageMetric {
  SEATS
  LEADS
  SEARCHES
  MESSAGES
}

model UsageCounter {
  id        String      @id @default(uuid())
  tenantId  String
  metric    UsageMetric
  value     Int         @default(0)
  period    String      // Format: "2026-01" for monthly metrics
  updatedAt DateTime    @updatedAt

  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric, period])
  @@index([tenantId])
  @@map("usage_counters")
}

// ==================== Platform Settings (Super Admin) ====================

model PlatformSettings {
  id          String   @id @default("default")
  
  // Platform URLs
  platformUrl     String   @default("http://localhost:3000")  // Web app URL
  apiUrl          String   @default("http://localhost:3001")  // API URL
  
  // Search Settings
  searchMethod        SearchMethod @default(GOOGLE_MAPS_REAL)  // GOOGLE_MAPS_REAL or GOOGLE_MAPS_API
  googleApiKey        String?      // Only used if searchMethod = GOOGLE_MAPS_API
  maxSearchResults    Int     @default(30)     // Max results for bulk search
  defaultCountry      String  @default("SA")   // Default country code (ISO 3166-1 alpha-2)
  
  // Extension Settings
  extensionAutoLogin    Boolean @default(true)   // Auto-login from platform
  extensionDebugMode    Boolean @default(false)  // Show debug info in extension
  
  // Subscription Settings (simplified for now)
  requireSubscription   Boolean @default(false)  // If false, all users are "subscribed"
  trialDays             Int     @default(14)     // Trial period for new tenants
  
  // Rate Limits
  searchRateLimit       Int     @default(10)     // Searches per minute
  crawlRateLimit        Int     @default(20)     // Page crawls per minute
  
  updatedAt DateTime @updatedAt

  @@map("platform_settings")
}

enum SearchMethod {
  GOOGLE_MAPS_REAL   // Real browser search (no API)
  GOOGLE_MAPS_API    // Google Places API
}

// Extension Settings per User
model ExtensionSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Search Layers
  enableGoogleMaps    Boolean @default(true)
  enableGoogleSearch  Boolean @default(true)
  enableSocialMedia   Boolean @default(false)
  
  // Match Settings
  matchThreshold      Int     @default(90)  // Minimum match score (0-100)
  
  // Search Settings
  maxResults          Int     @default(30)
  searchDelay         Int     @default(3)   // Seconds between searches
  
  // Window Settings
  showSearchWindow    Boolean @default(false)  // Show browser window during search
  
  // Social Media Platforms (JSON: { instagram: true, twitter: false, ... })
  socialPlatforms     Json    @default("{}")
  
  // Debug
  debugMode           Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("extension_settings")
}

